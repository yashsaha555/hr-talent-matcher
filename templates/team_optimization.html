{% extends "base.html" %}

{% block title %}Team Optimization - SkillBridge{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-users-cog me-2"></i>Team Optimization</h1>
    <small class="text-muted">AI-Powered Team Composition</small>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-project-diagram me-2"></i>Optimize Team for Project</h5>
            </div>
            <div class="card-body">
                <form id="optimizationForm">
                    <div class="mb-3">
                        <label for="project_id" class="form-label">Select Project</label>
                        <select class="form-select" id="project_id" name="project_id" required>
                            <option value="">Choose a project...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" 
                                    data-description="{{ project.description }}"
                                    data-duration="{{ project.estimated_duration_months }}"
                                    data-budget="{{ project.budget }}">
                                {{ project.project_name }} - {{ project.priority }} Priority
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="projectDetails" class="mb-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>Project Details:</h6>
                                <p id="projectDescription" class="small"></p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small><strong>Duration:</strong> <span id="projectDuration"></span> months</small>
                                    </div>
                                    <div class="col-md-6">
                                        <small><strong>Budget:</strong> $<span id="projectBudget"></span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-cogs me-2"></i>Optimize Team
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-robot me-2"></i>Optimization Algorithm</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Our AI considers:</p>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-primary me-2"></i>Skill coverage</li>
                    <li><i class="fas fa-check text-success me-2"></i>Team synergy</li>
                    <li><i class="fas fa-check text-info me-2"></i>Experience balance</li>
                    <li><i class="fas fa-check text-warning me-2"></i>Cost optimization</li>
                    <li><i class="fas fa-check text-secondary me-2"></i>Availability status</li>
                </ul>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        The algorithm uses constraint satisfaction and greedy optimization to find the best team composition.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4" id="optimizationResults" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users me-2"></i>Optimized Team</h5>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
// Show project details when project is selected
document.getElementById('project_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const detailsDiv = document.getElementById('projectDetails');
    
    if (selectedOption.value) {
        document.getElementById('projectDescription').textContent = selectedOption.dataset.description;
        document.getElementById('projectDuration').textContent = selectedOption.dataset.duration;
        document.getElementById('projectBudget').textContent = parseInt(selectedOption.dataset.budget).toLocaleString();
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
});

document.getElementById('optimizationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const projectId = formData.get('project_id');
    const submitBtn = this.querySelector('button[type="submit"]');
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Optimizing...';
    submitBtn.disabled = true;
    
    fetch(`/api/optimize-team/${projectId}`)
    .then(response => response.json())
    .then(data => {
        if (data.recommended_team) {
            displayOptimizationResults(data);
            document.getElementById('optimizationResults').style.display = 'block';
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while optimizing the team.');
    })
    .finally(() => {
        // Reset button
        submitBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Optimize Team';
        submitBtn.disabled = false;
    });
});

function displayOptimizationResults(data) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = '<div class="row">';
    
    // Team Overview
    html += '<div class="col-md-8">';
    html += '<h6>Recommended Team Members:</h6>';
    
    if (data.recommended_team && data.recommended_team.length > 0) {
        html += '<div class="row">';
        data.recommended_team.forEach((member, index) => {
            html += `<div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">${member.name}</h6>
                                <p class="card-text small">
                                    <strong>Role:</strong> ${member.role || 'Not specified'}<br>
                                    <strong>Experience:</strong> ${member.experience_years} years<br>
                                    <strong>Department:</strong> ${member.department}<br>
                                    <strong>Location:</strong> ${member.location}
                                </p>
                                <div class="mb-2">
                                    <small><strong>Key Skills:</strong></small><br>
                                    ${member.skills ? member.skills.slice(0, 5).map(skill => 
                                        `<span class="badge bg-secondary me-1">${skill}</span>`
                                    ).join('') : 'No skills listed'}
                                </div>
                            </div>
                        </div>
                     </div>`;
        });
        html += '</div>';
    } else {
        html += '<p class="text-muted">No team members found.</p>';
    }
    
    html += '</div>';
    
    // Team Metrics
    html += '<div class="col-md-4">';
    html += '<h6>Team Metrics:</h6>';
    
    html += '<div class="card bg-light mb-3">';
    html += '<div class="card-body">';
    html += `<div class="text-center">
                <h5>Team Size</h5>
                <h3 class="text-primary">${data.team_size || 0}</h3>
             </div>`;
    html += '</div></div>';
    
    if (data.team_synergy_score !== undefined) {
        const synergyPercentage = Math.round(data.team_synergy_score * 100);
        const synergyColor = synergyPercentage >= 80 ? 'success' : synergyPercentage >= 60 ? 'warning' : 'danger';
        html += '<div class="card bg-light mb-3">';
        html += '<div class="card-body">';
        html += '<h6>Team Synergy</h6>';
        html += `<div class="progress mb-2">
                    <div class="progress-bar bg-${synergyColor}" role="progressbar" 
                         style="width: ${synergyPercentage}%">${synergyPercentage}%</div>
                 </div>`;
        html += '</div></div>';
    }
    
    if (data.skill_coverage !== undefined) {
        const coveragePercentage = Math.round(data.skill_coverage * 100);
        const coverageColor = coveragePercentage >= 80 ? 'success' : coveragePercentage >= 60 ? 'warning' : 'danger';
        html += '<div class="card bg-light mb-3">';
        html += '<div class="card-body">';
        html += '<h6>Skill Coverage</h6>';
        html += `<div class="progress mb-2">
                    <div class="progress-bar bg-${coverageColor}" role="progressbar" 
                         style="width: ${coveragePercentage}%">${coveragePercentage}%</div>
                 </div>`;
        html += '</div></div>';
    }
    
    if (data.total_cost) {
        html += '<div class="card bg-light mb-3">';
        html += '<div class="card-body">';
        html += `<div class="text-center">
                    <h6>Estimated Cost</h6>
                    <h4 class="text-success">$${parseInt(data.total_cost).toLocaleString()}</h4>
                    <small class="text-muted">Annual salaries</small>
                 </div>`;
        html += '</div></div>';
    }
    
    if (data.estimated_success_rate !== undefined) {
        const successPercentage = Math.round(data.estimated_success_rate * 100);
        html += '<div class="card bg-light mb-3">';
        html += '<div class="card-body">';
        html += `<div class="text-center">
                    <h6>Success Rate</h6>
                    <h3 class="text-info">${successPercentage}%</h3>
                 </div>`;
        html += '</div></div>';
    }
    
    html += '</div></div>';
    
    resultsContent.innerHTML = html;
}
</script>
{% endblock %}
